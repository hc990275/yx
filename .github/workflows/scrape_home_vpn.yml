name: 抓取家宽 VPN 信息 (Shell版)

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '*/5 * * * *'  # 每5分钟运行一次

jobs:
  scrape-and-filter:
    runs-on: ubuntu-latest
    
    # 必须设置写入权限，否则无法推送到仓库
    permissions:
      contents: write
      
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 抓取并处理数据
        env:
          # 请确保在 GitHub 仓库 Settings -> Secrets 中设置了 VPN_SOURCE_URL
          VPN_SOURCE_URL: ${{ secrets.VPN_SOURCE_URL }}
        run: |
          # 1. 创建/进入目录 (如果需要放在特定文件夹，比如 '家宽')
          mkdir -p 家宽
          cd 家宽
          
          # 2. 下载网页内容 (静默模式 -s)
          echo "正在从 $VPN_SOURCE_URL 获取数据..."
          curl -s "$VPN_SOURCE_URL" > raw_page.html
          
          # 3. 提取所有 IPv4 地址
          # 使用 grep 正则匹配 IP，sort 排序，uniq 去重
          grep -E -o '([0-9]{1,3}[\.]){3}[0-9]{1,3}' raw_page.html | sort | uniq > all_ips.txt
          
          # ---------------------------------------------------------
          # 任务 A: 生成 README.md (包含所有 IP)
          # ---------------------------------------------------------
          echo "# 家宽 VPN 完整列表" > README.md
          echo "" >> README.md
          echo "> 更新时间: $(date '+%Y-%m-%d %H:%M:%S')" >> README.md
          echo "" >> README.md
          echo "| IP 地址 |" >> README.md
          echo "| :--- |" >> README.md
          
          # 使用 awk 将 IP 格式化为 Markdown 表格行
          awk '{print "| " $0 " |"}' all_ips.txt >> README.md
          
          # ---------------------------------------------------------
          # 任务 B: 生成 非219IP.md (过滤掉 219 开头的)
          # ---------------------------------------------------------
          echo "# 非 219 开头的 IP 列表" > 非219IP.md
          echo "" >> 非219IP.md
          echo "> 更新时间: $(date '+%Y-%m-%d %H:%M:%S')" >> 非219IP.md
          echo "" >> 非219IP.md
          
          # 核心过滤命令：grep -v "^219\." 表示排除以 219. 开头的行
          echo "```text" >> 非219IP.md
          grep -v "^219\." all_ips.txt >> 非219IP.md || echo "无数据" >> 非219IP.md
          echo "```" >> 非219IP.md

          # 清理临时文件
          rm raw_page.html all_ips.txt

      - name: 提交并推送更改
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          
          # 检查文件是否有变化
          # 只要 README.md 或 非219IP.md 有任何一个变动，就提交
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "自动更新: 同步 VPN 列表 (含非219筛选) [$(date '+%H:%M')]"
            git push
          else
            echo "数据无变化，跳过提交。"
          fi
